//===== rAthena Script =======================================
//= Hunting Missions
//===== By: ==================================================
//= Euphy
//===== Current Version: =====================================
//= 1.4
//===== Compatible With: ===================================== 
//= rAthena Project
//===== Description: =========================================
//= Random hunting missions.
//= Rewards are based on quest difficulty.
//= 
//= NOTE: Requires SQL mob database.
//===== Additional Comments: =================================
//= 1.0 Initial script.
//= 1.1 Small improvements and fixes.
//= 1.2 Added party support and replaced blacklists with an
//=     SQL query, both thanks to AnnieRuru.
//= 1.3 Re-added a blacklist adapted for the SQL query.
//= 1.3a Added mission reset options.
//= 1.3b Function updates.
//= 1.4 Check for deleted characters, thanks to AnnieRuru.
//=     Syntax updates and style cleaning.
//============================================================

prontera,152,186,6	script	Hunting Missions	4_F_EDEN_MASTER,{
function Chk;
	// Immersive, world-reactive greeting
	mes "[Hunting Missions]";
	// Disabled world state HTTP fetch for compatibility
	// set .@world_url$, "http://localhost:8998/ai/world/state?scope=summary";
	// set .@world_state$, httpget(.@world_url$);
	// set .@event_msg$, (strsearch(.@world_state$, "\"event\":") ? substr(.@world_state$, strsearch(.@world_state$, "\"event\":") + 8, 80) : "");
	// if (.@event_msg$ != "") {
	// 	mes "The world is restless: " + .@event_msg$;
	// }
	mes "Greetings, " + strcharinfo(0) + ".";
	if (!#Mission_Delay) {
		next;
		mes "[Hunting Missions]";
		mes "I can't find any records...";
		mes "You must be new here!";
		emotion ET_HUK;
		next;
		callsub Mission_Info;
		emotion ET_GO;
		#Mission_Delay = 1;
		close;
	}
	mes F_Rand("The world is always changing...", "Not slacking, I hope? The creatures surely aren't.");
	mes "What brings you to my post today?";
	mes " ";
	mes "^777777~ You've completed " + F_InsertPlural(Mission_Total,"mission",0,"^0055FF%d^777777 %s") + ". ~^000000";
	next;
	switch(select(
		((!Mission0) ? " ~ New Mission::" : ": ~ Mission Status: ~ Abandon Mission") +
		": ~ Information: ~ Mission Shop: ~ View Top Hunters: ~ ^777777Cancel^000000"
	)) {
	case 1:
		mes "[Hunting Missions]";
		if (#Mission_Count) {
			mes "You've started a mission";
			mes "on another character.";
			if (!@hm_char_del_check) {  // check for deleted character
				query_sql("SELECT 1 FROM `char_reg_num` WHERE `key` = 'Mission0' AND `char_id` IN(SELECT `char_id` FROM `char` WHERE `account_id` = " + getcharid(3) + ")", .@i);
				if (!.@i) {
					next;
					mes "[Hunting Missions]";
					mes "I can't seem to find any records";
					mes "for that character, though...";
					mes "One moment, please.";
					emotion ET_SCRATCH;
					#Mission_Count = 0;
				}
				@hm_char_del_check = true;
			}
			close;
		}
		if (#Mission_Delay > gettimetick(2) && .Delay) {
			mes "I'm afraid you'll have to wait " + Time2Str(#Mission_Delay) + " before taking another mission.";
			close;
		}
		// === AI-Autonomous-World Dynamic Mission Integration ===
		mes "Let me consult the world for a suitable hunt...";
		set .@url$, "http://localhost:8998/ai/quest/generate";
		set .@json$, "{"
			+ "\"npc_id\":\"hunting_mission_npc\","
			+ "\"npc_name\":\"Hunting Master\","
			+ "\"npc_class\":\"hunter\","
			+ "\"player_level\":" + BaseLevel + ","
			+ "\"player_class\":\"" + strcharinfo(3) + "\","
			+ "\"party_size\":" + ((getcharid(1)) ? getpartymembercount(getcharid(1)) : 1) + ","
			+ "\"location\":\"" + strcharinfo(3) + "\""
			+ "}";
		setarray .@header$[0], "Content-Type: application/json";
		set .@resp$, httppost(.@url$, .@json$, .@header$);

		if (.@resp$ == "") {
			mes "[Hunting Missions]";
			mes "The world is silent... (AI server unreachable)";
			close;
		}

				// --- Enhanced AI-Autonomous-World JSON parsing for dynamic objectives ---
				// Use a more robust approach to parse objectives and rewards from the AI API response.
				// This block replaces the primitive string search with a more reliable parser if available.
				// If a JSON parser function is available in your server, use it here for production.
				// Otherwise, this block will attempt to extract up to .Quests objectives and all reward fields.
		
				// Parse objectives (up to .Quests)
				for (.@i = 0; .@i < .Quests; .@i++) {
					set .@mob_id, atoi(strsearch(.@resp$, "\"mob_id\":", .@i*30) ? substr(.@resp$, strsearch(.@resp$, "\"mob_id\":", .@i*30) + 8, 5) : "0");
					set .@count, atoi(strsearch(.@resp$, "\"count\":", .@i*30) ? substr(.@resp$, strsearch(.@resp$, "\"count\":", .@i*30) + 8, 3) : "0");
					setd "Mission" + .@i, .@mob_id;
					setd "Mission" + .@i + "_", 0;
					setd "MissionCount" + .@i, .@count;
				}
				#Mission_Count = getd("MissionCount0");
		
				// Parse rewards
				set .@reward_points, atoi(strsearch(.@resp$, "\"points\":") ? substr(.@resp$, strsearch(.@resp$, "\"points\":") + 9, 4) : "10");
				set .@reward_baseexp, atoi(strsearch(.@resp$, "\"base_exp\":") ? substr(.@resp$, strsearch(.@resp$, "\"base_exp\":") + 11, 7) : "10000");
				set .@reward_jobexp, atoi(strsearch(.@resp$, "\"job_exp\":") ? substr(.@resp$, strsearch(.@resp$, "\"job_exp\":") + 10, 7) : "5000");
				set .@reward_zeny, atoi(strsearch(.@resp$, "\"zeny\":") ? substr(.@resp$, strsearch(.@resp$, "\"zeny\":") + 7, 7) : "10000");
				setd "MissionRewardPoints", .@reward_points;
				setd "MissionRewardBaseExp", .@reward_baseexp;
				setd "MissionRewardJobExp", .@reward_jobexp;
				setd "MissionRewardZeny", .@reward_zeny;
		
				// Show immersive, world-reactive objectives to player
				mes "[Hunting Missions]";
				for (.@i = 0; .@i < .Quests; .@i++) {
					if (getd("Mission" + .@i) > 0) {
						// Add flavor based on reason if available
						set .@reason$, (strsearch(.@resp$, "\"reason\":", .@i*30) ? substr(.@resp$, strsearch(.@resp$, "\"reason\":", .@i*30) + 10, 24) : "");
						if (strsearch(.@reason$, "overpopulation") >= 0)
							mes " > ^FF9900Culling^000000: " + getd("MissionCount" + .@i) + "x " + getmonsterinfo(getd("Mission" + .@i), MOB_NAME) + " (population surge)";
						else if (strsearch(.@reason$, "mutation") >= 0)
							mes " > ^CC00FFMutation^000000: " + getd("MissionCount" + .@i) + "x " + getmonsterinfo(getd("Mission" + .@i), MOB_NAME) + " (mutated threat)";
						else if (strsearch(.@reason$, "legendary") >= 0)
							mes " > ^00CCFFLegendary^000000: " + getd("MissionCount" + .@i) + "x " + getmonsterinfo(getd("Mission" + .@i), MOB_NAME) + " (rare sighting!)";
						else if (strsearch(.@reason$, "emergent") >= 0)
							mes " > ^FF3333Emergent Threat^000000: " + getd("MissionCount" + .@i) + "x " + getmonsterinfo(getd("Mission" + .@i), MOB_NAME) + " (emergent event)";
						else
							mes " > Hunt " + getd("MissionCount" + .@i) + "x " + getmonsterinfo(getd("Mission" + .@i), MOB_NAME);
					}
				}
				// Add world event flavor if available
				set .@event_msg$, (strsearch(.@resp$, "\"world_event\":") ? substr(.@resp$, strsearch(.@resp$, "\"world_event\":") + 14, 80) : "");
				if (.@event_msg$ != "") {
					mes "^777777[World Event]^000000: " + .@event_msg$;
				}
				mes "The world is watching. Return when your task is done.";
				mes "Good luck, and may the living world favor your hunt.";
				close;
	case 2:
		mes "[Hunting Missions]";
		mes "Mission status:";
		callsub Mission_Status;
		close;
	case 3:
		mes "[Hunting Missions]";
		mes "Do you really want to";
		mes "abandon your mission?";
		if (.Reset < 0 && .Delay)
			mes "Your delay time will not be reset.";
		else if (.Reset > 0)
			mes "It will cost " + F_InsertComma(.Reset) + " Zeny.";
		next;
		switch(select(" ~ Abandon...: ~ ^777777Cancel^000000")) {
		case 1:
			if (.Reset > 0) {
				if (Zeny < .Reset) {
					mes "[Hunting Missions]";
					mes "You don't have enough";
					mes "Zeny to drop this mission.";
					emotion ET_SORRY;
					close;
				}
				Zeny -= .Reset;
				emotion ET_MONEY;
			}
			mes "[Hunting Missions]";
			mes "Alright, I've dropped";
			mes "your current mission.";
			specialeffect2 EF_STORMKICK4;
			for (.@i = 0; .@i < .Quests; .@i++) {
				setd "Mission"+.@i, 0;
				setd "Mission"+.@i+"_", 0;
			}
			#Mission_Count = 0;
			if (.Reset < 0 && .Delay)
				#Mission_Delay = gettimetick(2) + (.Delay * 3600);
			close;
		case 2:
			mes "[Hunting Missions]";
			mes "I knew you were kidding!";
			mes "Keep up the good work.";
			emotion ET_SMILE;
			close;
		}
	case 4:
		callsub Mission_Info;
		close;
	case 5:
		mes "[Hunting Missions]";
		mes "You have ^0055FF" + #Mission_Points + "^000000 Mission Points.";
		mes "Use them well!";
		callshop "mission_shop",1;
		npcshopattach "mission_shop";
		end;
	case 6:
		mes "[Hunting Missions]";
		mes "The top hunters are:";
		query_sql("SELECT char_id AS id, (SELECT `name` FROM `char` WHERE char_id = id),`value` FROM `char_reg_num` WHERE `key` = 'Mission_Total' ORDER BY CAST(`value` AS SIGNED) DESC LIMIT 5", .@id, .@name$, .@val);
		for (.@i = 0; .@i < 5; .@i++)
			mes "  [Rank " + (.@i+1) + "]  " + ((.@name$[.@i] == "") ? "^777777none" : "^0055FF" + .@name$[.@i]+"^000000 : ^FF0000" + .@val[.@i] + " pt.") + "^000000";
		close;
	case 7:
		mes "[Hunting Missions]";
		mes "Nothing? Okay...";
		emotion ET_SCRATCH;
		close;
	}
	end;

Mission_Status:
	@f = false;
	deletearray .@j[0], getarraysize(.@j);
	for (.@i = 0; .@i < .Quests; .@i++) {
		.@j[.@i] = getd("Mission" + .@i);
		mes " > "+Chk(getd("Mission"+.@i+"_"),getd("MissionCount"+.@i)) + getmonsterinfo(.@j[.@i], MOB_NAME) + " (" + getd("Mission"+.@i+"_") + "/" + getd("MissionCount"+.@i) + ")^000000";
	}

	// Use AI-driven rewards if available, else fallback to static
	.@Mission_Points = getd("MissionRewardPoints") ? getd("MissionRewardPoints") : 10;
	.@Base_Exp = getd("MissionRewardBaseExp") ? getd("MissionRewardBaseExp") : 10000;
	.@Job_Exp = getd("MissionRewardJobExp") ? getd("MissionRewardJobExp") : 5000;
	.@Zeny = getd("MissionRewardZeny") ? getd("MissionRewardZeny") : 10000;

	next;
	mes "[Hunting Missions]";
	mes "Mission rewards:";
	mes " > Mission Points: ^0055FF" + .@Mission_Points + "^000000";
	mes " > Base Experience: ^0055FF" + F_InsertComma(.@Base_Exp) + "^000000";
	mes " > Job Experience: ^0055FF" + F_InsertComma(.@Job_Exp) + "^000000";
	mes " > Zeny: ^0055FF" + F_InsertComma(.@Zeny) + "^000000";
	if (@f) {
		@f = false;
		return;
	}
	next;
	mes "[Hunting Missions]";
	mes "Oh, you're done!";
	mes "The world feels a little safer.";
	mes "Here's your reward, as decreed by the living world.";
	emotion ET_BEST;
	specialeffect2 EF_ANGEL;
	specialeffect2 EF_TRUESIGHT;
	#Mission_Points += .@Mission_Points;
	BaseExp += .@Base_Exp;
	JobExp += .@Job_Exp;
	Zeny += .@Zeny;
	for (.@i = 0; .@i < .Quests; .@i++) {
		setd "Mission" + .@i, 0;
		setd "Mission" + .@i+"_", 0;
		setd "MissionCount" + .@i, 0;
	}
	#Mission_Count = 0;
	if (.Delay)
		#Mission_Delay = gettimetick(2) + (.Delay * 3600);
	Mission_Total++;
	if (Mission_Total == 1)
		query_sql("INSERT INTO `char_reg_num` (`char_id`,`key`,`index`,`value`) VALUES (" + getcharid(0) + ",'Mission_Total','0',1)");
	else
		query_sql("UPDATE `char_reg_num` SET `value` = " + Mission_Total + " WHERE `char_id` = " + getcharid(0) + " AND `key` = 'Mission_Total'");

	// --- Post-combat analysis and follow-up quest logic ---
	set .@feedback_url$, "http://localhost:8998/ai/quest/feedback";
	set .@feedback_json$, "{"
		+ "\"npc_id\":\"hunting_mission_npc\","
		+ "\"player_name\":\"" + strcharinfo(0) + "\","
		+ "\"objectives_completed\":" + .Quests + ","
		+ "\"party_size\":" + ((getcharid(1)) ? getpartymembercount(getcharid(1)) : 1) + ","
		+ "\"player_level\":" + BaseLevel + ","
		+ "\"location\":\"" + strcharinfo(3) + "\""
		+ "}";
	setarray .@header$[0], "Content-Type: application/json";
	set .@feedback_resp$, httppost(.@feedback_url$, .@feedback_json$, .@header$);

	if (.@feedback_resp$ != "") {
		// Parse feedback and follow-up quest (placeholder)
		set .@feedback_msg$, (strsearch(.@feedback_resp$, "\"feedback\":") ? substr(.@feedback_resp$, strsearch(.@feedback_resp$, "\"feedback\":") + 11, 120) : "The world is grateful for your efforts.");
		set .@has_followup, (strsearch(.@feedback_resp$, "\"followup\":") ? 1 : 0);
		mes "[Hunting Missions]";
		mes "Post-hunt analysis:";
		mes .@feedback_msg$;
		if (.@has_followup) {
			mes "A new urgent mission is available!";
			if (select("Accept follow-up quest:Decline") == 1) {
				// In a real implementation, parse and assign the follow-up quest here
				mes "You have accepted the world's urgent call. Prepare yourself!";
				// (Optionally, trigger another API call to assign the quest)
			} else {
				mes "You take a moment to rest, letting others answer the call.";
			}
		}
	}
	close;

Mission_Info:
	mes "[Hunting Missions]";
	mes "If you so choose, I can assign";
	mes "you a random hunting quest.";
	mes "Some are easier than others, but";
	mes "the rewards increase with difficulty.";
	next;
	mes "[Hunting Missions]";
	mes "Missions points are shared";
	mes "amongst all your characters.";
	if (.Delay)
		mes "Delay time is, too.";
	mes "You can't take missions on";
	mes "multiple characters at once.";
	next;
	mes "[Hunting Missions]";
	mes "You can start a quest";
	mes (.Delay ? "every " + ((.Delay == 1) ? "hour." : .Delay + " hours.") : "whenever you want.");
	mes "That's everything~";
	return;

function Chk {
	if (getarg(0) < getarg(1)) {
		@f = true;
		return "^FF0000";
	} else
		return "^00FF00";
}

OnBuyItem:
	.@size = getarraysize(@bought_nameid);
	for (.@i = 0; .@i < .@size; .@i++) {
		.@j = inarray(.Shop, @bought_nameid[.@i]);
		.@cost += (.Shop[.@j+1] * @bought_quantity[.@i]);
	}
	mes "[Hunting Missions]";
	if (.@cost > #Mission_Points)
		mes "You don't have enough Mission Points.";
	else {
		for (.@i = 0; .@i < .@size; .@i++) {
			getitem @bought_nameid[.@i], @bought_quantity[.@i];
			dispbottom "Purchased " + @bought_quantity[.@i] + "x " + getitemname(@bought_nameid[.@i]) + ".";
		}
		#Mission_Points -= .@cost;
		mes "Deal completed.";
		emotion ET_MONEY;
	}
	deletearray @bought_nameid[0], .@size;
	deletearray @bought_quantity[0], .@size;
	close;

OnNPCKillEvent:
	// AI-driven multi-objective progress tracking
	if (!getcharid(1) || !.Party) {
		// Solo or no party logic
		for (.@i = 0; .@i < .Quests; .@i++) {
			if (getd("Mission" + .@i) > 0 && getmonsterinfo(killedrid, MOB_NAME) == getmonsterinfo(getd("Mission" + .@i), MOB_NAME)) {
				if (getd("Mission" + .@i + "_") < getd("MissionCount" + .@i)) {
					setd "Mission" + .@i + "_", getd("Mission" + .@i + "_") + 1;
					dispbottom "[Hunting Mission] Killed " + getd("Mission" + .@i + "_") + " of " + getd("MissionCount" + .@i) + " " + getmonsterinfo(killedrid, MOB_NAME) + ".";
				}
			}
		}
		// Check if all objectives are complete
		.@all_done = 1;
		for (.@i = 0; .@i < .Quests; .@i++) {
			if (getd("Mission" + .@i) > 0 && getd("Mission" + .@i + "_") < getd("MissionCount" + .@i)) {
				.@all_done = 0;
			}
		}
		if (.@all_done) {
			// All objectives complete, call Mission_Status for reward
			callsub Mission_Status;
		}
	} else if (.Party) {
		// Party logic (simplified for AI-driven objectives)
		.@mob = killedrid;
		getmapxy(.@map1$,.@x1,.@y1);
		getpartymember getcharid(1),1;
		getpartymember getcharid(1),2;
		for (.@i = 0; .@i < $@partymembercount; .@i++) {
			if (isloggedin($@partymemberaid[.@i], $@partymembercid[.@i])) {
				set .@HP, readparam(HP, $@partymembercid[.@i]);
				if (.@HP > 0) {
					getmapxy(.@map2$,.@x2,.@y2,BL_PC,rid2name($@partymemberaid[.@i]));
					if ((.@map1$ == .@map2$ || .Party == 1) && (distance(.@x1,.@y1,.@x2,.@y2) <= 30 || .Party < 3)) {
						for (.@j = 0; .@j < .Quests; .@j++) {
							.@my_mob_id = getvar(getd("Mission"+.@j),$@partymembercid[.@i]);
							.@my_count = getvar(getd("Mission"+.@j+"_"), $@partymembercid[.@i]);
							.@my_goal = getvar(getd("MissionCount"+.@j), $@partymembercid[.@i]);
							if (.@my_mob_id > 0 && getmonsterinfo(.@mob, MOB_NAME) == getmonsterinfo(.@my_mob_id, MOB_NAME)) {
								if (.@my_count < .@my_goal) {
									setd "Mission"+.@j+"_", (.@my_count+1), $@partymembercid[.@i];
									dispbottom "[Hunting Mission] Killed " + (.@my_count+1) + " of " + .@my_goal + " " + getmonsterinfo(.@mob, MOB_NAME) + ".", 0x777777, $@partymembercid[.@i];
								}
							}
						}
						// Check if all objectives are complete for this party member
						.@all_done = 1;
						for (.@j = 0; .@j < .Quests; .@j++) {
							.@my_mob_id = getvar(getd("Mission"+.@j),$@partymembercid[.@i]);
							.@my_count = getvar(getd("Mission"+.@j+"_"), $@partymembercid[.@i]);
							.@my_goal = getvar(getd("MissionCount"+.@j), $@partymembercid[.@i]);
							if (.@my_mob_id > 0 && .@my_count < .@my_goal) {
								.@all_done = 0;
							}
						}
						if (.@all_done) {
							callsub Mission_Status;
						}
					}
				}
			}
		}
	}
	end;

OnInit:
	.Delay = 12;            // Quest delay, in hours (0 to disable).
	.Quests = 4;            // Number of subquests per mission (increases rewards).
	.Party = 3;             // Party options: 0 (exclude party kills), 1 (include party kills), 2 (same map only), 3 (screen area only)
	.Reset = -1;            // Reset options: -1 (abandoning mission sets delay time), 0 (no delay time), [Zeny] (cost to abandon mission, no delay time)
	setarray .Count[0],     // Min and max monsters per subquest (increases rewards).
		40,70;
	setarray .Modifier[0],  // Multipliers for Base Exp, Job Exp, and Zeny rewards.
		getbattleflag("base_exp_rate")/100,getbattleflag("job_exp_rate")/100,60;
	.mob_db$ =              // Table name of SQL mob database
		(checkre(0))?"mob_db_re":"mob_db";
	setarray .Shop[0],      // Reward items: <ID>,<point cost> (about 10~20 points per hunt).
		512,1,513,1,514,1,538,5,539,5,558,10,561,10;
	.Blacklist$ =           // Blacklisted mob IDs.
		"1062,1088,1183,1186,1200,1212,1220,1221,1234,1235,"+
		"1244,1245,1250,1268,1290,1293,1294,1296,1298,1299,"+
		"1300,1301,1303,1304,1305,1306,1308,1309,1311,1313,"+
		"1515,1588,1618,1676,1677,1678,1679,1796,1797,1974,"+
		"1975,1976,1977,1978,1979";

	npcshopdelitem "mission_shop",512;
	for (.@i = 0; .@i < getarraysize(.Shop); .@i += 2)
		npcshopadditem "mission_shop", .Shop[.@i], .Shop[.@i+1];
	end;
}
-	shop	mission_shop	-1,512:-1
