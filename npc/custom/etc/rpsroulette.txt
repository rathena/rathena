//===== rAthena Script =======================================
//= Rock Scissors Roulette (Fixed)
//===== By: ==================================================
//= acky + fixes
//===== Version: =============================================
//= 1.2f (menu fix + fair RNG + last choice logic fixed)
//============================================================

prontera,164,172,3	script	Crazy Elena	4_F_ELENA,{

	set .@counter, 1;
	set .@lastchoice, 0;

	mes "[Crazy Elena]";
	mes "Heh, you there!";
	mes "How about a round of ^0000FFRock^000000, ^FF0000Scissors^000000 and a bit of ^FF0000Russian Roulette^000000 on top?";
	mes "Win the mind game, survive the gun, and you walk away with prizes.";
	next;
	menu "Let me play.",PLAY,"Explain the rules (and prizes).",RULES,"Leave",LEAVE;

SAME:
	mes "[Crazy Elena]";
	mes "A draw!";
	mes "No fun in that... let's go again!";
	next;

PLAY:
	mes "[Crazy Elena]";
	mes "Alright... focus!";
	mes "^0000FFRock^000000... ^00FF00Paper^000000... ^FF0000Scissors^000000...";
	next;

	// Player choice menu (FIX: ROCK must go to a label)
	menu "^0000FFROCK!^000000",ROCK,"^FF0000SCISSORS!^000000",SCISSORS,"^00FF00PAPER!^000000",PAPER;

ROCK:
	set .@player, 1;
	goto DO_RPS;

SCISSORS:
	set .@player, 2;
	goto DO_RPS;

PAPER:
	set .@player, 3;
	goto DO_RPS;

DO_RPS:
	// Opponent choice (fair). Re-roll if we want to avoid repeating the SAME opponent choice as last time.
	set .@opp, rand(1,3);
	if (.@lastchoice > 0) {
		while (.@opp == .@lastchoice) set .@opp, rand(1,3);
	}
	set .@lastchoice, .@opp;

	// Show Elena emotion
	if (.@opp == 1) emotion ET_ROCK;
	else if (.@opp == 2) emotion ET_SCISSOR;
	else emotion ET_WRAP;

	// Determine outcome: 0 draw, 1 player win, 2 player lose
	set .@result, 0;

	// Rock(1) beats Scissors(2); Scissors(2) beats Paper(3); Paper(3) beats Rock(1)
	if (.@player == .@opp) set .@result, 0;
	else if ((.@player == 1 && .@opp == 2) || (.@player == 2 && .@opp == 3) || (.@player == 3 && .@opp == 1)) set .@result, 1;
	else set .@result, 2;

	if (.@result == 0) goto SAME;
	if (.@result == 1) goto WIN;
	goto LOSE;

WIN:
	mes "[Crazy Elena]";
	mes "Tch... You win this round!";
	mes "But the real fun starts with the trigger...";
	emotion ET_PROFUSELY_SWEAT;
	next;
	set .@win, 1; // You won RPS -> Elena risks dying
	goto YOUPULL;

LOSE:
	emotion ET_SMILE;
	mes "[Crazy Elena]";
	mes "Bwahaha! I win!";
	mes "Time to see if luck is on ^0000FFyour^000000 side.";
	next;
	set .@win, 0; // You lost RPS -> you risk dying
	goto YOUPULL;

YOUPULL:
	mes "[Crazy Elena]";
	mes "Chamber: ^FF0000" + .@counter + " of 6^000000.";
	if (.@counter == 6)
		mes "This is the last chamber... better start praying.";

	// Russian roulette odds: 1 bullet in remaining chambers (classic increasing probability)
	set .@pull, rand(1,(7 - .@counter));
	set .@counter, .@counter + 1;
	next;

	if (.@pull == 1) {
		// Bullet fired
		if (.@win) goto KILL; // If you won RPS, Elena takes the bullet
		specialeffect2 EF_SUI_EXPLOSION;
		emotion ET_KIK;
		percentheal -100,-100;
		mes "[Crazy Elena]";
		mes "*^0000FFClick^000000* ... *^FF0000BANG^000000*";
		mes "That was your last mistake...";
		mes "You're dead!";
		close;
	}

	// No bullet – continue
	emotion ET_HNG;
	mes "[Crazy Elena]";
	mes "*^0000FFClick^000000* ... whew, still alive.";
	mes "Again! Let's play another round!";
	next;
	goto PLAY;

RULES:
	mes "[Crazy Elena]";
	mes "Alright, listen up. How this little game works:";
	next;

	mes "[Crazy Elena]";
	mes "- I have a ^FF00006-chamber pistol^000000 with ^FF00001 bullet^000000.";
	mes "- First we play ^0000FFRock^000000, ^FF0000Scissors^000000, ^00FF00Paper^000000.";
	mes "- After each round, someone pulls the trigger once.";
	next;

	mes "[Crazy Elena]";
	mes "- If ^0000FFyou win^000000 the Rock Scissors Paper round and the bullet fires, ^FF0000I^000000 take the shot.";
	mes "- If ^FF0000you lose^000000 and the bullet fires, ^FF0000you^000000 die on the spot.";
	mes "- Survive the roulette ^AND^ beat me, and you walk away with a prize.";
	next;

	mes "[Crazy Elena]";
	mes "And what kind of prizes, you ask?";
	mes "- Special coins and tokens like ^00FF00" + getitemname(1230001) + "^000000 and ^00FF00" + getitemname(1230002) + "^000000.";
	mes "- Even rarer stuff like ^00FF00" + getitemname(1230003) + "^000000 for the lucky ones.";
	mes "- Useful items such as ^00FF00" + getitemname(616) + "^000000 and ^00FF00" + getitemname(617) + "^000000.";
	mes "- Dangerous items like ^00FF00" + getitemname(604) + "^000000.";
	next;

	mes "[Crazy Elena]";
	mes "Different rounds, different rewards. Sometimes you get coins, sometimes consumables, sometimes a nice surprise box.";
	mes "The only certainty is: if I take the bullet and survive long enough to talk, ^00FF00you get paid^000000.";
	next;

	menu "Let me play.",PLAY,"No thanks.",LEAVE;

KILL:
	// Elena takes the bullet, player wins a prize
	specialeffect EF_SUI_EXPLOSION;
	emotion ET_HUK;
	mes "[Crazy Elena]";
	mes "*^0000FFClick^000000* ... *^FF0000BANG^000000*";
	mes "OWWW!! That hurts every single time!";
	next;

	mes "[Crazy Elena]";
	mes "Alright, alright... a deal is a deal.";
	mes "You survived and beat me. Congratulations, you’ve won a prize!";
	next;

	// Reward pool
	switch (rand(1,10)) {
		case 1:  setarray .@reward[0],  2,1230002; break; // 2x custom coin (1230002)
		case 2:  setarray .@reward[0],  1,   616; break; // 1x Blue Potion
		case 3:  setarray .@reward[0],  5,1230002; break; // 5x custom coin (1230002)
		case 4:  setarray .@reward[0],  5,1230002; break; // 5x custom coin (1230002)
		case 5:  setarray .@reward[0],  4,   617; break; // 4x White Potion
		case 6:  setarray .@reward[0],  1,   616; break; // 1x Blue Potion
		case 7:  setarray .@reward[0], 10,   604; break; // 10x Yellow Potion
		case 8:  setarray .@reward[0],  3,   969; break; // 3x Old Blue Box
		case 9:  setarray .@reward[0], 50,1230001; break; // 50x custom coin (1230001)
		case 10: setarray .@reward[0], 10,1230002; break; // 10x custom coin (1230002)
	}

	mes "[Crazy Elena]";
	mes "You receive ^00FF00" + .@reward[0] + "x " + getitemname(.@reward[1]) + "^000000!";
	getitem .@reward[1], .@reward[0];
	close;

LEAVE:
	mes "[Crazy Elena]";
	mes "Hah! Chickening out, huh?";
	mes "Come back when you're ready to gamble with your life!";
	close;
}
