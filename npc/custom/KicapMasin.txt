//===== rAthena Script =======================================
//= KicapMasin - AI Showcase NPC
//===== By: ==================================================
//= AI-MMORPG-World Team
//===== Current Version: =====================================
//= 1.0 - Production Ready
//===== Compatible With: =====================================
//= rAthena Project + AI IPC System
//===== Description: =========================================
//= Comprehensive demonstration of ALL AI capabilities:
//= - AI Dialogue System (Database IPC)
//= - AI Decision Making
//= - AI Memory System
//= - NPC Autonomous Movement
//= - Error Handling & Graceful Degradation
//= - Multi-Menu Navigation
//=
//= This NPC uses ONLY verified working commands from:
//= - src/custom/script_ai_ipc.cpp (ai_db_* commands)
//= - src/custom/script_http.cpp (npcwalk command)
//= - Standard rAthena script commands
//=
//= See AI_NPC_GUIDE.md for implementation details
//============================================================

//============================================================
// MAIN SHOWCASE NPC - KicapMasin
//============================================================
prontera,155,185,5	script	KicapMasin	4_M_SAGE_C,{
	
	//========================================
	// Welcome Message
	//========================================
	mes "[^0000FFKicapMasin^000000]";
	mes "Greetings, " + strcharinfo(0) + "!";
	mes " ";
	mes "I am ^FF0000KicapMasin^000000, the AI Showcase NPC.";
	mes "I demonstrate the complete AI integration";
	mes "system with ^00AA0021 AI agents^000000 working together.";
	next;
	
	//========================================
	// Main Menu Loop
	//========================================
	while(1) {
		mes "[^0000FFKicapMasin^000000]";
		mes "What would you like to explore?";
		mes " ";
		mes "^777777Select a category:^000000";
		next;
		
		switch(select(
			"^0000FF1.^000000 AI Dialogue System",
			"^0000FF2.^000000 AI Decision Making",
			"^0000FF3.^000000 AI Memory System",
			"^0000FF4.^000000 NPC Movement Demo",
			"^0000FF5.^000000 Quest Generation",
			"^0000FF6.^000000 System Status",
			"^0000FF7.^000000 Technical Info",
			"^FF0000Exit^000000"
		)) {
			case 1: callsub S_Dialogue; break;
			case 2: callsub S_Decision; break;
			case 3: callsub S_Memory; break;
			case 4: callsub S_Movement; break;
			case 5: callsub S_Quest; break;
			case 6: callsub S_Status; break;
			case 7: callsub S_Technical; break;
			case 8:
				mes "[^0000FFKicapMasin^000000]";
				mes "Thank you for exploring the AI system!";
				mes "May your adventures be guided by intelligence.";
				close;
		}
	}
	
	close;

//============================================================
// SECTION 1: AI DIALOGUE SYSTEM
// Demonstrates: ai_db_request, ai_db_response, polling pattern
//============================================================
S_Dialogue:
	mes "[^0000FFAI Dialogue Demo^000000]";
	mes "The AI can generate contextual,";
	mes "personality-driven dialogue.";
	mes " ";
	mes "This uses the ^FF0000DialogueAgent^000000";
	mes "from the AI service.";
	next;
	
	mes "[^0000FFAI Dialogue Demo^000000]";
	mes "What would you like to say to me?";
	mes "I'll respond using AI-generated dialogue.";
	next;
	
	// Get player input
	input .@player_message$;
	
	if (.@player_message$ == "") {
		mes "[^0000FFKicapMasin^000000]";
		mes "^FF0000You didn't say anything!^000000";
		return;
	}
	
	// Build request data (proper JSON format)
	.@data$ = "{";
	.@data$ += "\"npc_id\":\"KicapMasin\",";
	.@data$ += "\"player_name\":\"" + strcharinfo(0) + "\",";
	.@data$ += "\"player_level\":" + BaseLevel + ",";
	.@data$ += "\"message\":\"" + .@player_message$ + "\",";
	.@data$ += "\"context\":\"dialogue\",";
	.@data$ += "\"personality\":\"friendly_sage\"";
	.@data$ += "}";
	
	mes "[^0000FFKicapMasin^000000]";
	mes "^777777Thinking... (requesting AI response)^000000";
	
	// Create AI request (priority 5 = normal)
	.@req_id = ai_db_request("ai_npc_dialogue", "/api/v1/npc/dialogue", .@data$, 5);
	
	if (.@req_id <= 0) {
		next;
		mes "[^0000FFKicapMasin^000000]";
		mes "^FF0000Error: Could not create AI request.^000000";
		mes "The AI service may be offline.";
		mes " ";
		mes "Fallback: I heard you say";
		mes "\"" + .@player_message$ + "\"";
		mes "but I cannot generate a smart response right now.";
		return;
	}
	
	// Poll for response (non-blocking with sleep2)
	// Maximum 50 attempts x 100ms = 5 seconds
	.@attempts = 0;
	.@max_attempts = 50;
	.@response$ = "";
	
	while (.@attempts < .@max_attempts && .@response$ == "") {
		sleep2 100;  // Wait 100ms
		.@response$ = ai_db_response(.@req_id);
		.@attempts++;
	}
	
	next;
	mes "[^0000FFKicapMasin - AI Response^000000]";
	
	if (.@response$ != "") {
		// Got response from AI
		mes "^00AA00" + .@response$ + "^000000";
		mes " ";
		mes "^777777(Generated by AI in " + (.@attempts * 100) + "ms)^000000";
	} else {
		// Timeout - check status
		.@status = ai_db_status(.@req_id);
		
		if (.@status == 1) {
			mes "^FFAA00AI is still thinking...^000000";
			mes "The request is pending in queue.";
		} else if (.@status == 2) {
			mes "^FFAA00AI is processing your request...^000000";
			mes "This is taking longer than expected.";
		} else if (.@status == 4) {
			mes "^FF0000AI request failed.^000000";
			mes "There was an error processing your request.";
		} else {
			mes "^FF8800Timeout: No response within 5 seconds.^000000";
			mes "The AI service may be busy or offline.";
		}
		
		mes " ";
		mes "Fallback: As a wise sage, I ponder your words";
		mes "\"" + .@player_message$ + "\" deeply.";
	}
	
	next;
	return;

//============================================================
// SECTION 2: AI DECISION MAKING
// Demonstrates: AI context-aware decisions
//============================================================
S_Decision:
	mes "[^0000FFAI Decision Demo^000000]";
	mes "The AI can make intelligent decisions";
	mes "based on context and game state.";
	mes " ";
	mes "Let me demonstrate by deciding what";
	mes "to offer you based on your character.";
	next;
	
	// Build decision context
	.@context$ = "{";
	.@context$ += "\"npc_id\":\"KicapMasin\",";
	.@context$ += "\"player_id\":" + getcharid(0) + ",";
	.@context$ += "\"player_name\":\"" + strcharinfo(0) + "\",";
	.@context$ += "\"player_level\":" + BaseLevel + ",";
	.@context$ += "\"player_class\":" + Class + ",";
	.@context$ += "\"player_job_level\":" + JobLevel + ",";
	.@context$ += "\"situation\":\"offer_assistance\",";
	.@context$ += "\"available_options\":[\"quest\",\"item\",\"buff\",\"advice\"]";
	.@context$ += "}";
	
	mes "[^0000FFKicapMasin^000000]";
	mes "^777777Analyzing your character...^000000";
	
	.@req_id = ai_db_request("ai_npc_decide_action", "/api/v1/npc/decide", .@context$, 5);
	
	if (.@req_id <= 0) {
		next;
		mes "[^0000FFKicapMasin^000000]";
		mes "^FF0000Cannot make AI decision right now.^000000";
		mes " ";
		mes "Fallback: Based on your level " + BaseLevel + ",";
		mes "I think you could use some experience!";
		return;
	}
	
	// Poll for decision
	.@attempts = 0;
	.@decision$ = "";
	
	while (.@attempts < 50 && .@decision$ == "") {
		sleep2 100;
		.@decision$ = ai_db_response(.@req_id);
		.@attempts++;
	}
	
	next;
	mes "[^0000FFAI Decision Result^000000]";
	
	if (.@decision$ != "") {
		mes "The AI has analyzed your character and decided:";
		mes " ";
		mes "^00AA00" + .@decision$ + "^000000";
		mes " ";
		mes "^777777Decision made in " + (.@attempts * 100) + "ms^000000";
	} else {
		mes "^FF8800AI decision timeout.^000000";
		mes " ";
		mes "Fallback: I'll offer you a simple blessing instead.";
		specialeffect2 EF_BLESSING;
		sc_start SC_BLESSING, 60000, 5;
		mes "You receive a blessing!";
	}
	
	next;
	return;

//============================================================
// SECTION 3: AI MEMORY SYSTEM
// Demonstrates: Persistent NPC memory
//============================================================
S_Memory:
	mes "[^0000FFAI Memory Demo^000000]";
	mes "The AI system includes memory sectors:";
	mes "^0000FF• Episodic^000000 - Event memories";
	mes "^00AA00• Semantic^000000 - Knowledge";
	mes "^FF00FF• Procedural^000000 - Skills";
	mes "^FFAA00• Emotional^000000 - Feelings";
	mes "^AA00FF• Reflective^000000 - Self-awareness";
	next;
	
	switch(select(
		"Store a Memory",
		"Check My Memories",
		"Clear Memories",
		"Back to Main Menu"
	)) {
		case 1:
			mes "[^0000FFStore Memory^000000]";
			mes "What would you like me to remember?";
			next;
			
			input .@memory_text$;
			
			if (.@memory_text$ == "") {
				mes "^FF0000No memory provided!^000000";
				return;
			}
			
			.@mem_data$ = "{";
			.@mem_data$ += "\"npc_id\":\"KicapMasin\",";
			.@mem_data$ += "\"player_id\":" + getcharid(0) + ",";
			.@mem_data$ += "\"player_name\":\"" + strcharinfo(0) + "\",";
			.@mem_data$ += "\"sector\":\"episodic\",";
			.@mem_data$ += "\"content\":\"" + .@memory_text$ + "\",";
			.@mem_data$ += "\"timestamp\":" + gettimetick(2) + ",";
			.@mem_data$ += "\"location\":\"prontera\"";
			.@mem_data$ += "}";
			
			.@req_id = ai_db_request("memory_store", "/api/v1/memory/store", .@mem_data$, 5);
			
			if (.@req_id <= 0) {
				next;
				mes "^FF0000Failed to create memory request.^000000";
				return;
			}
			
			// Wait for confirmation
			.@attempts = 0;
			.@result$ = "";
			
			while (.@attempts < 30 && .@result$ == "") {
				sleep2 100;
				.@result$ = ai_db_response(.@req_id);
				.@attempts++;
			}
			
			next;
			if (.@result$ != "") {
				mes "[^00AA00Memory Stored^000000]";
				mes "I will remember:";
				mes "^0000FF\"" + .@memory_text$ + "\"^000000";
			} else {
				mes "^FF8800Memory storage timeout.^000000";
				mes "Your memory may still be saved.";
			}
			break;
			
		case 2:
			mes "[^0000FFCheck Memories^000000]";
			mes "Searching for memories about you...";
			
			.@search_data$ = "{";
			.@search_data$ += "\"npc_id\":\"KicapMasin\",";
			.@search_data$ += "\"player_id\":" + getcharid(0) + ",";
			.@search_data$ += "\"limit\":5";
			.@search_data$ += "}";
			
			.@req_id = ai_db_request("memory_search", "/api/v1/memory/search", .@search_data$, 5);
			
			if (.@req_id <= 0) {
				next;
				mes "^FF0000Cannot search memories right now.^000000";
				return;
			}
			
			.@attempts = 0;
			.@result$ = "";
			
			while (.@attempts < 30 && .@result$ == "") {
				sleep2 100;
				.@result$ = ai_db_response(.@req_id);
				.@attempts++;
			}
			
			next;
			if (.@result$ != "") {
				mes "[^00AA00Your Memories^000000]";
				mes .@result$;
			} else {
				mes "^777777No memories found yet.^000000";
				mes "Try storing some memories first!";
			}
			break;
			
		case 3:
			mes "[^FF0000Clear Memories^000000]";
			mes "^FF0000Warning:^000000 This will erase all";
			mes "memories I have about you.";
			next;
			
			if (select("Confirm Clear", "Cancel") == 2) {
				return;
			}
			
			.@clear_data$ = "{\"npc_id\":\"KicapMasin\",\"player_id\":" + getcharid(0) + "}";
			.@req_id = ai_db_request("memory_clear", "/api/v1/memory/clear", .@clear_data$, 5);
			
			if (.@req_id > 0) {
				sleep2 500;
				mes "^00AA00Memories cleared.^000000";
			} else {
				mes "^FF0000Failed to clear memories.^000000";
			}
			break;
			
		case 4:
			return;
	}
	
	next;
	return;

//============================================================
// SECTION 4: NPC MOVEMENT DEMO
// Demonstrates: npcwalk command (verified working)
//============================================================
S_Movement:
	mes "[^0000FFMovement Demo^000000]";
	mes "I can move around autonomously!";
	mes "This demonstrates AI-driven NPC movement.";
	next;
	
	switch(select(
		"Watch Me Patrol",
		"Random Movement",
		"Return to Base",
		"Back to Menu"
	)) {
		case 1:
			mes "[^0000FFKicapMasin^000000]";
			mes "I'll patrol in a square pattern.";
			mes "Watch me move!";
			close2;
			
			// Patrol pattern: square around starting position
			npcwalk "KicapMasin", 160, 185;
			sleep2 2000;
			npcwalk "KicapMasin", 160, 190;
			sleep2 2000;
			npcwalk "KicapMasin", 155, 190;
			sleep2 2000;
			npcwalk "KicapMasin", 155, 185;
			
			npctalk "Patrol complete!";
			break;
			
		case 2:
			mes "[^0000FFKicapMasin^000000]";
			mes "I'll move to a random nearby location.";
			close2;
			
			.@rand_x = 155 + rand(-10, 10);
			.@rand_y = 185 + rand(-10, 10);
			
			if (npcwalk("KicapMasin", .@rand_x, .@rand_y)) {
				npctalk "Moving to (" + .@rand_x + "," + .@rand_y + ")!";
				sleep2 3000;
				npcwalk "KicapMasin", 155, 185;
			} else {
				npctalk "Movement failed - path blocked?";
			}
			break;
			
		case 3:
			mes "[^0000FFKicapMasin^000000]";
			mes "Returning to my starting position...";
			close2;
			
			npcwalk "KicapMasin", 155, 185;
			npctalk "I'm home!";
			break;
			
		case 4:
			return;
	}
	
	end;

//============================================================
// SECTION 5: QUEST GENERATION
// Demonstrates: AI quest generation
//============================================================
S_Quest:
	mes "[^0000FFAI Quest Generator^000000]";
	mes "The AI can generate personalized quests";
	mes "tailored to your level and class.";
	next;
	
	mes "[^0000FFAI Quest Generator^000000]";
	mes "Shall I generate a quest for you?";
	next;
	
	if (select("Yes, generate quest", "No, go back") == 2) {
		return;
	}
	
	.@quest_data$ = "{";
	.@quest_data$ += "\"player_id\":" + getcharid(0) + ",";
	.@quest_data$ += "\"player_name\":\"" + strcharinfo(0) + "\",";
	.@quest_data$ += "\"base_level\":" + BaseLevel + ",";
	.@quest_data$ += "\"job_level\":" + JobLevel + ",";
	.@quest_data$ += "\"job_class\":" + Class + ",";
	.@quest_data$ += "\"current_map\":\"" + strcharinfo(3) + "\",";
	.@quest_data$ += "\"quest_type\":\"auto\"";
	.@quest_data$ += "}";
	
	mes "[^0000FFKicapMasin^000000]";
	mes "^777777Generating personalized quest...^000000";
	
	.@req_id = ai_db_request("quest_generate", "/api/v1/quest/generate", .@quest_data$, 5);
	
	if (.@req_id <= 0) {
		next;
		mes "^FF0000Cannot generate quest right now.^000000";
		mes " ";
		mes "Fallback: Here's a simple quest:";
		mes "^00AA00Hunt 10 Porings for 1000 Base EXP!^000000";
		return;
	}
	
	.@attempts = 0;
	.@quest$ = "";
	
	while (.@attempts < 50 && .@quest$ == "") {
		sleep2 100;
		.@quest$ = ai_db_response(.@req_id);
		.@attempts++;
	}
	
	next;
	mes "[^00AA00Generated Quest^000000]";
	
	if (.@quest$ != "") {
		mes .@quest$;
		mes " ";
		mes "^777777Generated in " + (.@attempts * 100) + "ms^000000";
	} else {
		mes "^FF8800Quest generation timeout.^000000";
		mes " ";
		mes "Sample Quest for Level " + BaseLevel + ":";
		mes "^00AA00Hunt 10 suitable monsters";
		mes "Reward: Experience points^000000";
	}
	
	next;
	return;

//============================================================
// SECTION 6: SYSTEM STATUS
// Demonstrates: Health check and status monitoring
//============================================================
S_Status:
	mes "[^0000FFSystem Status^000000]";
	mes "Checking AI service health...";
	
	// Health check request
	.@req_id = ai_db_request("health_check", "/api/v1/health", "{}", 10);
	
	if (.@req_id <= 0) {
		next;
		mes "^FF0000Cannot create health check request.^000000";
		mes " ";
		mes "Database: ^00AA00Connected^000000";
		mes "AI Service: ^FF0000Unreachable^000000";
		return;
	}
	
	// Quick poll
	.@attempts = 0;
	.@health$ = "";
	
	while (.@attempts < 20 && .@health$ == "") {
		sleep2 100;
		.@health$ = ai_db_response(.@req_id);
		.@attempts++;
	}
	
	next;
	mes "[^0000FFSystem Status^000000]";
	mes "Database IPC: ^00AA00Active^000000";
	
	if (.@health$ != "") {
		mes "AI Service: ^00AA00Online^000000";
		mes "Response Time: " + (.@attempts * 100) + "ms";
		mes " ";
		mes "^00AA00All systems operational!^000000";
	} else {
		.@status = ai_db_status(.@req_id);
		
		if (.@status == 1 || .@status == 2) {
			mes "AI Service: ^FFAA00Slow^000000";
			mes "Status: " + (.@status == 1 ? "Pending" : "Processing");
		} else {
			mes "AI Service: ^FF0000Offline/Timeout^000000";
		}
		
		mes " ";
		mes "Worker Service: Check logs";
		mes "Python AI: Check systemctl status";
	}
	
	next;
	return;

//============================================================
// SECTION 7: TECHNICAL INFORMATION
// Educational info about the system
//============================================================
S_Technical:
	mes "[^0000FFTechnical Information^000000]";
	mes "This showcase uses:";
	mes " ";
	mes "^0000FFScript Commands:^000000";
	mes "• ai_db_request() - Create request";
	mes "• ai_db_response() - Get response";
	mes "• ai_db_status() - Check status";
	mes "• ai_db_cancel() - Cancel request";
	mes "• npcwalk() - NPC movement";
	next;
	
	mes "[^0000FFTechnical Information^000000]";
	mes "^00AA00Architecture:^000000";
	mes "NPC Script → C++ Commands →";
	mes "MySQL Database (IPC Queue) →";
	mes "Python Worker Service →";
	mes "FastAPI AI Service →";
	mes "21 AI Agents (CrewAI)";
	next;
	
	mes "[^0000FFTechnical Information^000000]";
	mes "^FF0000Performance:^000000";
	mes "• Request creation: <1ms";
	mes "• Database round-trip: 10-50ms";
	mes "• AI processing: 100-5000ms";
	mes "• Total latency: ~200-5000ms";
	mes " ";
	mes "^FFAA00Non-blocking:^000000 Uses sleep2 polling";
	mes "to avoid freezing the game server.";
	next;
	
	mes "[^0000FFTechnical Information^000000]";
	mes "^AA00FFAvailable AI Agents:^000000";
	mes "DialogueAgent, DecisionAgent,";
	mes "MemoryAgent, QuestAgent,";
	mes "WorldEventAgent, EconomyAgent,";
	mes "FactionAgent, WeatherTimeAgent,";
	mes "and 13 more specialized agents!";
	next;
	
	mes "[^0000FFTechnical Information^000000]";
	mes "For implementation details, see:";
	mes "^0000FF/doc/AI_NPC_GUIDE.md^000000";
	mes " ";
	mes "Source code:";
	mes "^00AA00/src/custom/script_ai_ipc.cpp^000000";
	mes "^00AA00/src/custom/script_http.cpp^000000";
	next;
	
	return;
}

//============================================================
// OnInit: Server startup
//============================================================
-	script	KicapMasin_Init	FAKE_NPC,{
OnInit:
	debugmes "[KicapMasin] AI Showcase NPC initialized";
	debugmes "[KicapMasin] Location: prontera (155,185)";
	debugmes "[KicapMasin] All AI features available";
	end;
}
