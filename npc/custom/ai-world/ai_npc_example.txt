//===== rAthena Script =======================================
//= AI-Enabled NPC Example
//===== Description: =========================================
//= Example NPC demonstrating AI autonomous behavior
//= Uses Bridge Layer to communicate with AI Service
//===== Author: ==============================================
//= AI Autonomous World System
//============================================================

// AI-Enabled Merchant NPC
prontera,150,180,4	script	AI Merchant#ai001	4_M_MERCHANT,{
	
	// Get player information
	.@player_id = getcharid(0);
	.@player_name$ = strcharinfo(0);
	.@player_class$ = jobname(Class);
	.@player_level = BaseLevel;
	
	// Build interaction request
	.@npc_id$ = "ai_merchant_001";
	.@interaction_type$ = "talk";
	.@message$ = "";
	
	// Get current map and position
	.@map$ = strcharinfo(3);
	.@x = getmapxy(.@map$, .@x, .@y, 0);
	
	// Get time and weather
	.@time_of_day$ = "day";  // Could be enhanced with actual time system
	.@weather$ = "clear";
	
	// Build JSON request for player interaction
	.@json$ = "{";
	.@json$ += "\"npc_id\":\"" + .@npc_id$ + "\",";
	.@json$ += "\"player_id\":\"" + .@player_id + "\",";
	.@json$ += "\"interaction_type\":\"" + .@interaction_type$ + "\",";
	.@json$ += "\"message\":\"" + .@message$ + "\",";
	.@json$ += "\"timestamp\":\"" + gettimestr("%Y-%m-%dT%H:%M:%S", 21) + "\",";
	.@json$ += "\"context\":{";
	.@json$ += "\"player_name\":\"" + .@player_name$ + "\",";
	.@json$ += "\"player_class\":\"" + .@player_class$ + "\",";
	.@json$ += "\"player_level\":" + .@player_level + ",";
	.@json$ += "\"location\":{\"map\":\"" + .@map$ + "\",\"x\":" + .@x + ",\"y\":" + .@y + "},";
	.@json$ += "\"time_of_day\":\"" + .@time_of_day$ + "\",";
	.@json$ += "\"weather\":\"" + .@weather$ + "\"";
	.@json$ += "}";
	.@json$ += "}";

	// Call AI Service via Bridge Layer
	.@bridge_url$ = "http://localhost:8888";
	.@response$ = httppost(.@bridge_url$ + "/ai/player/interaction", .@json$);

	// Parse response (simplified - in production, use proper JSON parsing)
	if (.@response$ == "") {
		// Fallback if AI service is unavailable
		mes "[AI Merchant]";
		mes "Greetings, " + .@player_name$ + "!";
		mes "I am an AI-enabled merchant.";
		mes "(AI service unavailable)";
		close;
	}

	// Display AI-generated dialogue
	mes "[AI Merchant]";
	mes .@response$;
	next;

	mes "[AI Merchant]";
	mes "What would you like to do?";
	next;

	switch(select("Talk:Trade:Quest:Leave")) {
		case 1:  // Talk
			callsub L_AITalk;
			break;
		case 2:  // Trade
			callsub L_AITrade;
			break;
		case 3:  // Quest
			callsub L_AIQuest;
			break;
		case 4:  // Leave
			mes "[AI Merchant]";
			mes "Farewell, adventurer!";
			close;
	}
	end;

L_AITalk:
	// Build talk interaction request
	.@talk_json$ = "{";
	.@talk_json$ += "\"npc_id\":\"" + .npc_id$ + "\",";
	.@talk_json$ += "\"player_id\":\"" + getcharid(0) + "\",";
	.@talk_json$ += "\"interaction_type\":\"talk\",";
	.@talk_json$ += "\"message\":\"Tell me about yourself\"";
	.@talk_json$ += "}";

	.@bridge_url$ = "http://localhost:8888";
	.@ai_response$ = httppost(.@bridge_url$ + "/ai/player/interaction", .@talk_json$);

	mes "[AI Merchant]";
	if (.@ai_response$ != "") {
		mes .@ai_response$;
	} else {
		mes "I've traveled far and wide,";
		mes "collecting rare items and";
		mes "stories from distant lands.";
	}
	return;

L_AITrade:
	// Get NPC action from AI service
	.@bridge_url$ = "http://localhost:8888";
	.@action_response$ = httpget(.@bridge_url$ + "/ai/npc/" + .npc_id$ + "/action");

	mes "[AI Merchant]";
	mes "Welcome to my shop!";
	mes "I offer special items that";
	mes "change based on market";
	mes "conditions and world state.";
	next;

	// In full implementation, parse action_response for dynamic pricing
	mes "[AI Merchant]";
	if (.@action_response$ != "") {
		mes "AI-powered dynamic pricing active!";
		mes .@action_response$;
	} else {
		mes "Shop functionality integrated";
		mes "with AI economic system!";
	}
	return;

L_AIQuest:
	// Generate AI quest
	.@quest_json$ = "{";
	.@quest_json$ += "\"npc_id\":\"" + .npc_id$ + "\",";
	.@quest_json$ += "\"player_id\":\"" + getcharid(0) + "\",";
	.@quest_json$ += "\"player_level\":" + BaseLevel + ",";
	.@quest_json$ += "\"player_class\":\"" + jobname(Class) + "\"";
	.@quest_json$ += "}";

	.@bridge_url$ = "http://localhost:8888";
	.@quest_response$ = httppost(.@bridge_url$ + "/ai/quest/generate", .@quest_json$);

	mes "[AI Merchant]";
	mes "I have a task for you!";
	mes "The AI system has determined";
	mes "that you would be perfect for";
	mes "this quest.";
	next;

	mes "[AI Merchant]";
	if (.@quest_response$ != "") {
		mes "AI-generated quest:";
		mes .@quest_response$;
	} else {
		mes "Quest generation active!";
		mes "Dynamic quests based on";
		mes "your level and preferences.";
	}
	return;

OnInit:
	// Register NPC with AI Service on server start
	.npc_id$ = "ai_merchant_001";
	.npc_name$ = "AI Merchant";
	.npc_class$ = "merchant";
	.npc_level = 50;
	
	// Build registration JSON
	.@reg_json$ = "{";
	.@reg_json$ += "\"npc_id\":\"" + .npc_id$ + "\",";
	.@reg_json$ += "\"name\":\"" + .npc_name$ + "\",";
	.@reg_json$ += "\"npc_class\":\"" + .npc_class$ + "\",";
	.@reg_json$ += "\"level\":" + .npc_level + ",";
	.@reg_json$ += "\"position\":{\"map\":\"prontera\",\"x\":150,\"y\":180},";
	.@reg_json$ += "\"personality\":{";
	.@reg_json$ += "\"openness\":0.7,";
	.@reg_json$ += "\"conscientiousness\":0.8,";
	.@reg_json$ += "\"extraversion\":0.6,";
	.@reg_json$ += "\"agreeableness\":0.9,";
	.@reg_json$ += "\"neuroticism\":0.3,";
	.@reg_json$ += "\"moral_alignment\":\"lawful_good\"";
	.@reg_json$ += "}";
	.@reg_json$ += "}";

	// Register NPC with AI service
	.@bridge_url$ = "http://localhost:8888";
	.@reg_response$ = httppost(.@bridge_url$ + "/ai/npc/register", .@reg_json$);

	if (.@reg_response$ != "") {
		debugmes "[AI World] NPC " + .npc_id$ + " registered successfully: " + .@reg_response$;
	} else {
		debugmes "[AI World] NPC " + .npc_id$ + " registration failed (AI service unavailable)";
	}
	end;
}

