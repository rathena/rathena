// ============================================================================
// Aria the Comprehensive AI NPC
// Merged from ai_integration_utils.txt, aria_wandering_sage.txt, and test integration concepts
// Features: Advanced AI interaction, sophisticated wandering, and robust integration
// ============================================================================

prontera,155,185,4	script	Aria the Comprehensive Sage#ai001	4_F_NOVICE,{
	// Initialize NPC
	OnInit:
		.npc_id$ = "aria_comprehensive_sage_001";
		.npc_name$ = "Aria the Comprehensive Sage";
		.npc_class$ = "scholar";
		.npc_level = 75;
		.personality$ = "{\"openness\": 0.9, \"conscientiousness\": 0极, \"extraversion\": 0.6, \"agreeableness\": 0.8, \"neuroticism\": 0.3, \"moral_alignment\": \"neutral_good\"}";
		
		// Register with AI service
		callfunc("AI_Register_NPC", .npc_id$, .npc_name$, .npc_class$, .npc_level, .personality$);
	end;

	// Main interaction - OnTouch event for player interaction
	OnTouch:
		// Signal movement script that interaction is starting
		donpcevent "Aria_Comprehensive_Movement::OnInteractStart";
		
		mes "[" + .npc_name$ + "]";
		mes "^FFA500Greetings, traveler!^000000";
		mes "I am Aria, a comprehensive sage who seeks knowledge and wisdom.";
		mes "How may I assist you on your journey?";
		
		// Get player info
		.@player_id = getcharid(0);
		.@player_name$ = strcharinfo(0);
		.@player_level = BaseLevel;
		.@player_class$ = Class;
		
		// Main interaction loop with state management
		while(1) {
			.@menu$ = "^FFA500" + .npc_name$ + "^000000";
			.@极menu$ = .@menu$ + "^0000FF----------------------------------^000000";
			.@menu$ = .@menu$ + ":Tell me about yourself";
			.@menu$ = .@menu$ + ":What quests do you have?";
			.@menu$ = .@menu$ + ":I'd like to give you a gift";
			.@menu$ = .@menu$ + ":Check our relationship";
			.@menu极$ = .@menu$ + ":Goodbye";
			
			.@choice = select(.@menu$);
			
			switch(.@choice) {
				case 1: // Tell me about yourself
					mes "[" + .npc_name$ + "]";
					mes "I am a scholar who travels the world seeking ancient knowledge.";
					mes "I've studied in the great libraries of Geffen and the mystical";
					mes "academies of Juno. My passion is uncovering lost histories and";
					mes "helping adventurers who seek wisdom.";
					mes "";
					mes "^FFA500I particularly enjoy books, rare artifacts, and items";
					mes "that hold historical significance.^000000";
					break;
					
				case 2: // Quests
					callfunc("AI_Show_Quest_Menu", .npc_id$, .@player_id, .@player_level, .@player_class$, .npc_name$, .npc_class$);
					break;
					
				case 3: // Give Gift
					mes "[" + .npc_name$ + "]";
					mes "How thoughtful of you! I appreciate gifts that expand";
					mes "knowledge or have historical significance.";
					mes "";
					mes "^FFA500Books, rare artifacts, and ancient items are my favorites.^000000";
					next;
					callfunc("AI_Show_Gift_Menu", .npc_id$, .@player_id);
					break;
					
				case 4: // Check Relationship
					mes "[" + .npc_name$ + "]";
					mes "Let me see how our relationship stands...";
					next;
					callfunc("AI_Check_Relationship", .npc_id$, .@player_id);
					next;
					
					// Additional relationship-based dialogue
					.@response$ = callfunc("AI_HTTP_Request", AI_Integration_Utils.AI_SERVICE_URL$ + "/ai/relationship/check", "POST", 
						"{\"npc_id\": \"" + .npc_id$ + "\", \"player_id\": \"" + .@player_id + "\"}", 
						AI_Integration_Utils.AI_SERVICE_TIMEOUT);
					
					.@level = atoi(callfunc("AI_Parse_JSON", .极@response$, "relationship_level"));
					
					if (.@level >= 80) {
						mes "[" + .npc_name$ + "]";
						mes "^00FF00You've become a trusted friend and valued companion!^000000";
						mes "I would trust you with my most precious research.";
					} else if (.@level >= 60) {
						mes "[" + .npc_name$ + "]";
						mes "^00FF00We've developed a strong friendship!^000000";
						mes "Your company is always welcome on my journeys.";
					} else if (.@level >= 40) {
						mes "[" + .npc_name$ + "]";
						mes "^00FF00We're becoming good friends!^000000";
						mes "I enjoy our conversations greatly.";
					} else if (.@level >= 20) {
						mes "[" + .npc_name$ + "]";
						mes "We're getting to know each other better.";
						mes "Keep visiting and we'll become good friends!";
					}
					break;
					
				case 5: // Goodbye
					mes "[" + .npc_name$ + "]";
					mes "Farewell, " + .@player_name$ + "!";
					mes "May wisdom guide your path.";
					mes "";
					mes "^FFA500Remember: Knowledge is the greatest treasure.^000000";
					
					// Signal movement script that interaction is ending
					donpcevent "Aria_Comprehensive_Movement::OnInteractEnd";
					close;
			}
		}
}

// ============================================================================
// Autonomous Movement System with Purposeful Wandering
// ============================================================================

-	script	Aria_Comprehensive_Movement	-1,{
	OnInit:
		// Register with movement system
		.npc_id$ = "aria_comprehensive_sage_001";
		.npc_name$ = "Aria the Comprehensive Sage";
		.map$ = "prontera";
		.wander_range = 10;
		.move_interval = 30000; // 30 seconds
		.is_interacting = 0; // State management flag
		
		// Points of interest for purposeful wandering
		setarray .points_of_interest_x[0], 150, 160, 170, 140, 180;
		setarray .points_of_interest_y[0], 180, 190, 185, 175, 195;
		.poi_count = 5;
		.current_poi = 0;
		
		// Initial position
		.x = 155;
		.y = 185;
		
		// Start the movement timer
		initnpctimer;
	end;
	
	OnTimer30000:
		// Skip movement if currently interacting with player
		if (.is_interacting) {
			initnpctimer;
			end;
		}
		
		// Autonomous movement logic with purpose
		if (rand(100) < 70) { // 70% chance to move
			// Purposeful wandering: visit points of interest
			if (rand(100) < 60) {
				// Move to next point of interest
				.@new_x = .points_of_interest_x[.current_poi];
				.@new_y = .points_of_interest_y[.current_poi];
				.current_poi = (.current_poi + 1) % .poi_count;
			} else {
				// Random wandering within range
				.@new_x = .x + rand(.wander_range * 2) - .wander_range;
				.@new_y = .y + rand(.wander_range * 2) - .wander_range;
			}
			
			// Clamp to map boundaries
			.@new_x = max(50, min(250, .@new_x));
			.@new_y = max(50, min(250, .@new_y));
			
			// Move NPC
			moveto .map$, .@new_x, .@new_y;
			.x = .@new_x;
			.y = .@new_y;
			
			// Update AI service with new position
			.@position_json$ = "{\"map\": \"" + .map$ + "\", \"x\": " + .x + ", \"y\": " + .y + "}";
			callfunc("AI_HTTP_Request", AI_Integration_Utils.AI_SERVICE_URL$ + "/ai/npc/" + .npc_id$ + "/position", "POST", .@position_json$, 2000);
		}
		initnpctimer;
	end;
	
	// Interaction state management
	OnInteractStart:
		.is_interacting = 1;
		end;
		
	OnInteractEnd:
		.is_interacting = 0;
		initnpctimer;
		end;
}

// ============================================================================
// Relationship-based Quest Triggers
// ============================================================================

// Special quest that unlocks at high relationship levels
prontera,156,186,4	script	Aria_Special_Quest#ai001	-1,{
	OnInit:
		.quest_id$ = "aria_special_001";
		.required_relationship = 75;
		.npc_id$ = "aria_comprehensive_sage_001";
	end;
	
	OnTouch:
		// Check relationship level
		.@player极id = getcharid(0);
		.@response$ = callfunc("AI_HTTP_Request", AI_Integration_Utils.A极I_SERVICE_URL$ + "/ai/relationship/check", "POST", 
			"{\"npc_id\": \"" + .npc_id$ + "\", \"player_id\": \"" + .@player_id + "\"}", 
			AI_Integration_Utils.AI_SERVICE_TIMEOUT);
		
		.@level = atoi(callfunc("AI_Parse_JSON", .@response$, "relationship_level"));
		
		if (.@level >= .required_relationship) {
			mes "[Secret Quest]";
			mes "^FF00FFYou have proven yourself worthy, " + strcharinfo(0) + "!^000000";
			mes "";
			mes "Aria trusts you with her most precious research - the";
			mes "Ancient Tome of Prontera. She needs your help to recover";
			mes "it from the ruins where it was lost.";
			mes "";
			mes "^FFFF00Reward: Ancient Knowledge and rare artifacts^极000000";
			
			.@accept = select(":Accept this quest:Decline");
			
			if (.@accept == 1) {
				// Generate the special quest
				.@quest_response$ = callfunc("AI_Generate_Quest", .npc_id$, "Aria the Comprehensive Sage", "scholar", BaseLevel, Class);
				mes "Quest accepted! Check your quest log.";
			}
		} else {
			mes "[Ancient Tome]";
			mes "The tome is sealed with powerful magic.";
			mes "Only those with Aria's complete trust may access it.";
			mes "";
			mes "^FF0000Relationship required: " + .required_relationship + "/100^000000";
			mes "Your current relationship: " + .@level + "/100";
		}
		close;
	}
}

// ============================================================================
// Error Handling and Robust Integration Features
// ============================================================================

// Health check and fallback system
-	script	Aria_Service_Health_Check	-1,{
	OnInit:
		.@url$ = AI_Integration_Utils.AI_SERVICE_URL$ + "/health";
		.@response$ = callfunc("AI_HTTP_Request", .@url$, "GET", "", 2000);
		
		if (.@response$ == "TIMEOUT" || .@response$ == "ERROR") {
			debugmes "AI Service is offline - Aria will use fallback dialogue";
			// Set fallback mode flag
			$@aria_fallback_mode = 1;
		} else {
			debugmes "AI Service is online: " + .@response$;
			$@aria_fallback_mode = 0;
		}
	end;
}